<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>가볍게 보는 금융 진단</title>
  <meta name="description" content="연령과 여유자금만으로 부담 없이 진단하고, 분산투자 힌트를 직관적으로 확인하세요."/>
  <style>
    :root{
      --c1:#0ea5e9; --c2:#6366f1; --c3:#22c55e; --c4:#f43f5e;
      --card:#ffffff; --text:#0f172a; --muted:#64748b;
      --line:rgba(15,23,42,.10); --shadow:0 14px 40px rgba(2,6,23,.12);
      --radius:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans KR",Arial,sans-serif;
      color:var(--text);
      background:
        radial-gradient(1200px 600px at 10% -10%, rgba(14,165,233,.35), transparent 60%),
        radial-gradient(1000px 600px at 110% 10%, rgba(99,102,241,.30), transparent 55%),
        radial-gradient(900px 520px at 30% 120%, rgba(34,197,94,.25), transparent 55%),
        #f7f8ff;
      min-height:100vh;
    }
    .wrap{max-width:860px;margin:0 auto;padding:28px 16px 80px}
    header{text-align:center;margin-bottom:18px}
    h1{margin:0;font-size:26px;letter-spacing:-.4px}
    .sub{margin-top:8px;color:var(--muted);font-size:14px;line-height:1.6}

    .shell{
      background:rgba(255,255,255,.75);
      border:1px solid rgba(255,255,255,.45);
      backdrop-filter: blur(10px);
      border-radius:calc(var(--radius) + 8px);
      box-shadow:var(--shadow);
      padding:16px;
    }
    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--radius);
      overflow:hidden;
    }
    .topbar{
      display:flex; align-items:center; justify-content:space-between;
      padding:14px 16px;
      background:linear-gradient(90deg, rgba(14,165,233,.16), rgba(99,102,241,.16));
      border-bottom:1px solid var(--line);
    }
    .brand{font-weight:900;display:flex;align-items:center;gap:10px}
    .dot{width:12px;height:12px;border-radius:999px;background:linear-gradient(135deg,var(--c1),var(--c2));box-shadow:0 6px 18px rgba(99,102,241,.35);}
    .progress{display:flex;gap:8px;align-items:center}
    .p{width:8px;height:8px;border-radius:999px;background:rgba(100,116,139,.25)}
    .p.on{background:linear-gradient(135deg,var(--c2),var(--c1))}

    .stage{position:relative;height:540px}
    @media(max-width:520px){ .stage{height:600px} }

    .view{
      position:absolute; inset:0;
      padding:18px 16px 16px;
      display:flex; flex-direction:column;
      transition: transform .35s ease, opacity .35s ease;
      opacity:0;
      transform: translateX(18px);
      pointer-events:none;
    }
    .view.active{opacity:1;transform:translateX(0);pointer-events:auto}

    .qbox{
      text-align:center;
      padding:16px;
      border-radius:14px;
      background:
        radial-gradient(600px 180px at 20% -10%, rgba(14,165,233,.28), transparent 60%),
        radial-gradient(520px 180px at 90% 10%, rgba(99,102,241,.22), transparent 60%),
        #f6f7ff;
      border:1px solid rgba(99,102,241,.18);
    }
    .qtitle{font-weight:900;font-size:18px;margin-bottom:6px}
    .qhint{color:var(--muted);font-size:13px}

    .grid{margin-top:14px;display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px}
    @media(max-width:520px){ .grid{grid-template-columns:1fr} }

    .opt{
      border:1px solid var(--line);
      border-radius:16px;
      padding:14px;
      background:rgba(255,255,255,.92);
      cursor:pointer;
      transition: transform .15s ease, box-shadow .15s ease, border-color .15s ease;
      display:flex; align-items:center; gap:12px;
    }
    .opt:hover{transform:translateY(-1px);border-color:rgba(99,102,241,.45);box-shadow:0 10px 26px rgba(2,6,23,.08);}

    .chip{width:38px;height:38px;border-radius:14px;display:grid;place-items:center;color:#fff;font-weight:900;flex:0 0 auto;
      background:linear-gradient(135deg,rgba(14,165,233,.95),rgba(99,102,241,.90));
      box-shadow:0 10px 18px rgba(99,102,241,.25);
    }
    .opt:nth-child(2) .chip{background:linear-gradient(135deg,rgba(34,197,94,.95),rgba(14,165,233,.88));}
    .opt:nth-child(3) .chip{background:linear-gradient(135deg,rgba(99,102,241,.95),rgba(168,85,247,.88));}
    .opt:nth-child(4) .chip{background:linear-gradient(135deg,rgba(244,63,94,.92),rgba(99,102,241,.90));}

    .label{font-weight:900}
    .desc{margin-top:4px;color:var(--muted);font-size:13px}

    .pillrow{text-align:center;margin:12px 0 6px}
    .pill{display:inline-block;padding:7px 12px;border-radius:999px;font-size:12px;font-weight:800;margin:4px;
      background:rgba(99,102,241,.12);border:1px solid rgba(99,102,241,.22);
    }

    .resultgrid{margin-top:10px;display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px}
    @media(max-width:520px){ .resultgrid{grid-template-columns:1fr} }

    .item{border:1px solid var(--line);border-radius:18px;padding:14px;background:rgba(255,255,255,.92);}
    .name{font-weight:900}
    .meta{margin-top:4px;color:var(--muted);font-size:12px}
    .amt{margin-top:10px;font-size:14px}
    .amt b{font-size:16px}
    .bar{height:10px;border-radius:999px;background:rgba(100,116,139,.18);overflow:hidden;margin-top:10px}
    .bar > div{height:100%;width:0%;background:linear-gradient(90deg,rgba(14,165,233,.95),rgba(99,102,241,.90));border-radius:999px;transition:width .5s ease;}

    .hint{margin-top:10px;color:var(--muted);font-size:12px;text-align:center}
    .note{margin-top:auto;padding-top:14px;color:var(--muted);font-size:12px;text-align:center;line-height:1.6}
  
    /* Admin */
    .gear{
      border:1px solid rgba(15,23,42,.12);
      background:rgba(255,255,255,.75);
      border-radius:999px;
      padding:8px 10px;
      cursor:pointer;
      font-size:14px;
      line-height:1;
      transition:transform .12s ease, box-shadow .12s ease;
    }
    .gear:hover{transform:translateY(-1px); box-shadow:0 10px 24px rgba(2,6,23,.10);}
    .modal{position:fixed; inset:0; display:none; z-index:50;}
    .modal.show{display:block;}
    .modal-backdrop{
      position:absolute; inset:0;
      background:rgba(2,6,23,.45);
      backdrop-filter: blur(2px);
    }
    .modal-card{
      position:absolute;
      left:50%; top:50%;
      transform:translate(-50%,-50%);
      width:min(860px, calc(100vw - 24px));
      max-height:calc(100vh - 24px);
      background:rgba(255,255,255,.92);
      border:1px solid rgba(255,255,255,.55);
      border-radius:22px;
      box-shadow:0 18px 60px rgba(2,6,23,.25);
      overflow:hidden;
      display:flex;
      flex-direction:column;
    }
    .modal-head{
      display:flex; gap:12px; align-items:flex-start;
      padding:16px 16px 12px;
      background:linear-gradient(90deg, rgba(14,165,233,.18), rgba(99,102,241,.18));
      border-bottom:1px solid rgba(15,23,42,.10);
    }
    .modal-title{font-weight:900; font-size:16px;}
    .modal-sub{margin-top:4px; color:var(--muted); font-size:12px; line-height:1.4}
    .modal-x{
      margin-left:auto;
      border:1px solid rgba(15,23,42,.12);
      background:rgba(255,255,255,.8);
      border-radius:12px;
      padding:8px 10px;
      cursor:pointer;
      line-height:1;
    }
    .modal-body{padding:14px 16px; overflow:auto;}
    .modal-grid{display:grid; grid-template-columns:1fr 1fr; gap:12px;}
    @media(max-width:720px){ .modal-grid{grid-template-columns:1fr;} }
    .row{
      border:1px solid rgba(15,23,42,.10);
      background:rgba(255,255,255,.9);
      border-radius:16px;
      padding:12px;
    }
    .row .k{font-weight:900; font-size:13px;}
    .row .k span{font-weight:700; color:var(--muted); margin-left:6px;}
    .row label{display:block; font-size:12px; color:var(--muted); margin-top:10px;}
    .row input{
      width:100%;
      margin-top:6px;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid rgba(15,23,42,.12);
      outline:none;
      background:#fff;
      font-size:13px;
    }
    .row .tog{display:flex; align-items:center; gap:10px; margin-top:10px; color:var(--muted); font-size:12px;}
    .row .tog input{width:auto; margin:0;}
    .modal-foot{
      padding:12px 16px 16px;
      border-top:1px solid rgba(15,23,42,.10);
      display:flex; gap:10px; align-items:center;
      background:rgba(255,255,255,.85);
    }
    .btn2{
      border:1px solid rgba(15,23,42,.14);
      background:#fff;
      border-radius:999px;
      padding:10px 14px;
      cursor:pointer;
      font-weight:800;
      font-size:13px;
    }
    .btn2.primary{
      border:none;
      color:#fff;
      background:linear-gradient(135deg, var(--c2), var(--c1));
      box-shadow:0 12px 22px rgba(99,102,241,.25);
    }
    .sbadge{
      display:inline-block;
      margin-left:8px;
      font-size:11px;
      padding:4px 9px;
      border-radius:999px;
      background:rgba(244,63,94,.12);
      border:1px solid rgba(244,63,94,.22);
      color:#be123c;
      font-weight:800;
    }
    .plink{
      color:inherit;
      text-decoration:none;
    }
    .plink:hover{text-decoration:underline;}

</style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>가볍게 보는 금융 진단</h1>
      <div class="sub">연령과 여유자금만 선택하면, <b>분산투자 힌트</b>가 가볍게 펼쳐져요.</div>
    </header>

    <div class="shell">
      <div class="card">
        <div class="topbar">
          <div class="brand"><span class="dot"></span> 1분 진단</div>
          <div class="progress" aria-label="진행상태">
            <span class="p" id="p1"></span>
            <span class="p" id="p2"></span>
            <span class="p" id="p3"></span>
          </div>

          <button class="gear" id="openAdmin" title="관리자 설정" aria-label="관리자 설정">⚙️</button>
        </div>

        <!-- Admin Modal -->
        <div class="modal" id="adminModal" aria-hidden="true">
          <div class="modal-backdrop" id="adminBackdrop"></div>
          <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="adminTitle">
            <div class="modal-head">
              <div>
                <div class="modal-title" id="adminTitle">상품명 변경(관리자)</div>
                <div class="modal-sub">여기서 바꾸면 바로 반영되고, 이 브라우저에 저장됩니다.</div>
              </div>
              <button class="modal-x" id="closeAdmin" aria-label="닫기">✕</button>
            </div>

            <div class="modal-body">
              <div class="modal-grid" id="adminList"></div>
            </div>

            <div class="modal-foot">
              <button class="btn2" id="resetAdmin">초기화</button>
              <div style="flex:1"></div>
              <button class="btn2 primary" id="saveAdmin">저장</button>
            </div>
          </div>
        </div>

        </div>

        <div class="stage">
          <div class="view active" id="viewAge">
            <div class="qbox">
              <div class="qtitle">1) 연령을 선택해 주세요</div>
              <div class="qhint">대략적인 구간만 고르면 충분해요</div>
            </div>
            <div class="grid" id="ageGrid"></div>
            <div class="note">본 결과는 일반 정보 제공 목적이며 투자 권유가 아닙니다.</div>
          </div>

          <div class="view" id="viewTier">
            <div class="qbox">
              <div class="qtitle">2) 여유자금 규모를 선택해 주세요</div>
              <div class="qhint">부담 없이 선택해도 괜찮아요</div>
            </div>
            <div class="grid" id="tierGrid"></div>
            <div class="hint">처음 화면으로 돌아가려면 새로고침(F5)을 이용해 주세요.</div>
            <div class="note">본 결과는 일반 정보 제공 목적이며 투자 권유가 아닙니다.</div>
          </div>

          <div class="view" id="viewResult">
            <div class="qbox">
              <div class="qtitle">추천 비중 힌트</div>
              <div class="qhint">분산 비중과 금액을 한눈에 정리했어요</div>
            </div>
            <div class="pillrow">
              <span class="pill" id="pillAge"></span>
              <span class="pill" id="pillTier"></span>
            </div>
            <div class="resultgrid" id="resultGrid"></div>
            <div class="hint">처음 화면으로 돌아가려면 새로고침(F5)을 이용해 주세요.</div>
            <div class="note">본 결과는 일반 정보 제공 목적이며 투자 권유가 아닙니다.</div>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
const PRODUCT_MAP = {
  "적금 및 예금": "카카오뱅크 정기예금",
  "실비보험": "삼성생명 실손의료보험",
  "진단보험": "교보생명 진단보험",
  "성장주ETF": "TIGER 미국S&P500 ETF",
  "고배당ETF": "KODEX 고배당 ETF",
  "변액연금": "삼성생명 변액연금",
  "변액종신": "한화생명 변액종신보험",
  "부동산투자": "리츠(REITs) ETF",
  "코인, 3배 ETF": "BITO 비트코인 ETF / 3배 레버리지 ETF"
};
const DATA = {"30대 이하": {"50만원 이상": [{"item": "적금 및 예금", "product": "적금 및 예금", "amount": 450000, "share": 0.9}, {"item": "실비보험", "product": "실비보험", "amount": 50000, "share": 0.1}], "100만원 이상": [{"item": "적금 및 예금", "product": "적금 및 예금", "amount": 600000, "share": 0.6}, {"item": "실비보험", "product": "실비보험", "amount": 100000, "share": 0.1}, {"item": "진단보험", "product": "진단보험", "amount": 100000, "share": 0.1}, {"item": "성장주ETF", "product": "성장주ETF", "amount": 200000, "share": 0.2}], "300만원 이상": [{"item": "적금 및 예금", "product": "적금 및 예금", "amount": 450000, "share": 0.15}, {"item": "실비보험", "product": "실비보험", "amount": 60000, "share": 0.02}, {"item": "성장주ETF", "product": "성장주ETF", "amount": 990000, "share": 0.33}, {"item": "변액종신", "product": "변액종신", "amount": 990000, "share": 0.33}, {"item": "변액연금", "product": "변액연금", "amount": 510000, "share": 0.17}], "500만원 이상": [{"item": "적금 및 예금", "product": "적금 및 예금", "amount": 750000, "share": 0.15}, {"item": "실비보험", "product": "실비보험", "amount": 100000, "share": 0.02}, {"item": "성장주ETF", "product": "성장주ETF", "amount": 1250000, "share": 0.25}, {"item": "코인, 3배 ETF", "product": "코인, 3배 ETF", "amount": 400000, "share": 0.08}, {"item": "부동산투자", "product": "부동산투자", "amount": 2500000, "share": 0.5}]}, "40대": {"50만원 이상": [{"item": "적금 및 예금", "product": "적금 및 예금", "amount": 450000, "share": 0.9}, {"item": "실비보험", "product": "실비보험", "amount": 50000, "share": 0.1}], "100만원 이상": [{"item": "적금 및 예금", "product": "적금 및 예금", "amount": 600000, "share": 0.6}, {"item": "실비보험", "product": "실비보험", "amount": 100000, "share": 0.1}, {"item": "진단보험", "product": "진단보험", "amount": 100000, "share": 0.1}, {"item": "성장주ETF", "product": "성장주ETF", "amount": 200000, "share": 0.2}], "300만원 이상": [{"item": "적금 및 예금", "product": "적금 및 예금", "amount": 600000, "share": 0.2}, {"item": "실비보험", "product": "실비보험", "amount": 60000, "share": 0.02}, {"item": "성장주ETF", "product": "성장주ETF", "amount": 1140000, "share": 0.38}, {"item": "변액종신", "product": "변액종신", "amount": 750000, "share": 0.25}, {"item": "변액연금", "product": "변액연금", "amount": 450000, "share": 0.15}], "500만원 이상": [{"item": "적금 및 예금", "product": "적금 및 예금", "amount": 1000000, "share": 0.2}, {"item": "실비보험", "product": "실비보험", "amount": 100000, "share": 0.02}, {"item": "변액종신", "product": "변액종신", "amount": 650000, "share": 0.13}, {"item": "부동산투자", "product": "부동산투자", "amount": 3250000, "share": 0.65}]}, "50대": {"50만원 이상": [{"item": "적금 및 예금", "product": "적금 및 예금", "amount": 450000, "share": 0.9}, {"item": "실비보험", "product": "실비보험", "amount": 50000, "share": 0.1}], "100만원 이상": [{"item": "적금 및 예금", "product": "적금 및 예금", "amount": 600000, "share": 0.6}, {"item": "실비보험", "product": "실비보험", "amount": 100000, "share": 0.1}, {"item": "진단보험", "product": "진단보험", "amount": 100000, "share": 0.1}, {"item": "성장주ETF", "product": "성장주ETF", "amount": 200000, "share": 0.2}], "300만원 이상": [{"item": "적금 및 예금", "product": "적금 및 예금", "amount": 750000, "share": 0.25}, {"item": "실비보험", "product": "실비보험", "amount": 60000, "share": 0.02}, {"item": "고배당ETF", "product": "고배당ETF", "amount": 600000, "share": 0.2}, {"item": "변액종신", "product": "변액종신", "amount": 990000, "share": 0.33}, {"item": "변액연금", "product": "변액연금", "amount": 600000, "share": 0.2}], "500만원 이상": [{"item": "적금 및 예금", "product": "적금 및 예금", "amount": 1000000, "share": 0.2}, {"item": "실비보험", "product": "실비보험", "amount": 100000, "share": 0.02}, {"item": "고배당ETF", "product": "고배당ETF", "amount": 750000, "share": 0.15}, {"item": "변액종신", "product": "변액종신", "amount": 650000, "share": 0.13}, {"item": "부동산투자", "product": "부동산투자", "amount": 2500000, "share": 0.5}]}, "60대 이상": {"50만원 이상": [{"item": "적금 및 예금", "product": "적금 및 예금", "amount": 450000, "share": 0.9}, {"item": "실비보험", "product": "실비보험", "amount": 50000, "share": 0.1}], "100만원 이상": [{"item": "적금 및 예금", "product": "적금 및 예금", "amount": 700000, "share": 0.7}, {"item": "실비보험", "product": "실비보험", "amount": 100000, "share": 0.1}, {"item": "고배당ETF", "product": "고배당ETF", "amount": 200000, "share": 0.2}], "300만원 이상": [{"item": "적금 및 예금", "product": "적금 및 예금", "amount": 900000, "share": 0.3}, {"item": "실비보험", "product": "실비보험", "amount": 150000, "share": 0.05}, {"item": "고배당ETF", "product": "고배당ETF", "amount": 1950000, "share": 0.65}], "500만원 이상": [{"item": "적금 및 예금", "product": "적금 및 예금", "amount": 1000000, "share": 0.2}, {"item": "실비보험", "product": "실비보험", "amount": 150000, "share": 0.03}, {"item": "고배당ETF", "product": "고배당ETF", "amount": 1850000, "share": 0.37}, {"item": "부동산투자", "product": "부동산투자", "amount": 2000000, "share": 0.4}]}};

const LS_KEY = "ffg_product_overrides_v1";

function loadOverrides(){
  try{
    const raw = localStorage.getItem(LS_KEY);
    return raw ? JSON.parse(raw) : {};
  }catch(e){ return {}; }
}
function saveOverrides(obj){
  localStorage.setItem(LS_KEY, JSON.stringify(obj || {}));
}

let OVERRIDES = loadOverrides(); // { itemKey: {name, url, sponsored} }

function getProductName(itemKey, fallback){
  const o = OVERRIDES && OVERRIDES[itemKey];
  return (o && o.name) ? o.name : fallback;
}
function getProductUrl(itemKey){
  const o = OVERRIDES && OVERRIDES[itemKey];
  return (o && o.url) ? o.url : "";
}
function getSponsored(itemKey){
  const o = OVERRIDES && OVERRIDES[itemKey];
  return !!(o && o.sponsored);
}


const AGE_ORDER = Object.keys(DATA);
const TIER_ORDER = ["50만원 이상","100만원 이상","300만원 이상","500만원 이상"];

const ageGrid = document.getElementById("ageGrid");
const tierGrid = document.getElementById("tierGrid");
const resultGrid = document.getElementById("resultGrid");
const pillAge = document.getElementById("pillAge");
const pillTier = document.getElementById("pillTier");
const vAge = document.getElementById("viewAge");
const vTier = document.getElementById("viewTier");
const vRes = document.getElementById("viewResult");
const p1 = document.getElementById("p1");
const p2 = document.getElementById("p2");
const p3 = document.getElementById("p3");

const state = { age:null, tier:null, step:0 };

function fmt(n){ return "₩" + Math.round(Number(n||0)).toLocaleString("ko-KR"); }
function pct(x){ const v = Number(x||0)*100; const out = Math.abs(v-Math.round(v))<1e-9?Math.round(v):(Math.round(v*10)/10); return out + "%"; }
function esc(s){ return String(s??"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#39;"); }

function setProgress(step){
  p1.classList.toggle("on", step>=0);
  p2.classList.toggle("on", step>=1);
  p3.classList.toggle("on", step>=2);
}

function show(view){
  [vAge, vTier, vRes].forEach(v => v.classList.remove("active"));
  view.classList.add("active");
}

function renderAges(){
  ageGrid.innerHTML = "";
  AGE_ORDER.forEach((a, idx) => {
    const d = document.createElement("div");
    d.className = "opt";
    d.innerHTML = `<div class="chip">${idx+1}</div>
      <div>
        <div class="label">${esc(a)}</div>
        <div class="desc">부담 없이 가볍게 시작</div>
      </div>`;
    d.onclick = () => {
      state.age = a;
      state.step = 1;
      renderTiers();
      setProgress(1);
      show(vTier);
    };
    ageGrid.appendChild(d);
  });
}

function renderTiers(){
  tierGrid.innerHTML = "";
  TIER_ORDER.forEach((t, idx) => {
    const d = document.createElement("div");
    d.className = "opt";
    d.innerHTML = `<div class="chip">${idx+1}</div>
      <div>
        <div class="label">${esc(t)}</div>
        <div class="desc">이 금액대의 분산 예시 보기</div>
      </div>`;
    d.onclick = () => {
      state.tier = t;
      state.step = 2;
      renderResult();
      setProgress(2);
      show(vRes);
      requestAnimationFrame(() => {
        document.querySelectorAll("[data-bar]").forEach(el => {
          el.style.width = el.getAttribute("data-bar") + "%";
        });
      });
    };
    tierGrid.appendChild(d);
  });
}

function renderResult(){
  pillAge.textContent = state.age || "";
  pillTier.textContent = state.tier || "";

  const list = (DATA[state.age] && DATA[state.age][state.tier]) ? DATA[state.age][state.tier] : [];
  resultGrid.innerHTML = list.map(x => {
    const baseName = (PRODUCT_MAP && PRODUCT_MAP[x.item]) ? PRODUCT_MAP[x.item] : (x.product || x.item || "");
    const product = getProductName(x.item, baseName);
    const url = getProductUrl(x.item);
    const sponsored = getSponsored(x.item);
    const sharePct = Number(x.share||0) * 100;
    const barW = Math.max(0, Math.min(100, Math.round(sharePct)));
    return `
      <div class="item">
        <div class="name">${url ? `<a class='plink' href='${esc(url)}' target='_blank' rel='noopener noreferrer'>${esc(product)}</a>` : esc(product)}${sponsored ? `<span class='sbadge'>광고</span>` : ''}</div>
        <div class="meta">${esc(x.item || "")}</div>
        <div class="amt"><b>${pct(x.share)}</b> · ${fmt(x.amount)}</div>
        <div class="bar" aria-hidden="true"><div data-bar="${barW}"></div></div>
      </div>
    `;
  }).join("");
}



const PWD_KEY = "ffg_admin_pwd_hash_v1";

async function sha256(text){
  const enc = new TextEncoder().encode(text);
  const buf = await crypto.subtle.digest("SHA-256", enc);
  return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,"0")).join("");
}

function hasPassword(){
  return !!localStorage.getItem(PWD_KEY);
}

async function ensurePassword(){
  const modal = document.getElementById("pwdModal");
  const msg = document.getElementById("pwdMsg");
  const input = document.getElementById("pwdInput");
  msg.style.display = "none";
  input.value = "";
  modal.classList.add("show");
  modal.setAttribute("aria-hidden","false");

  return new Promise((resolve) => {
    async function submit(){
      const v = input.value || "";
      if(v.length < 8){
        msg.textContent = "비밀번호는 8자리 이상이어야 합니다.";
        msg.style.display = "block";
        return;
      }
      const h = await sha256(v);
      const stored = localStorage.getItem(PWD_KEY);
      if(!stored){
        localStorage.setItem(PWD_KEY, h);
        close();
        resolve(true);
      }else if(stored === h){
        close();
        resolve(true);
      }else{
        msg.textContent = "비밀번호가 일치하지 않습니다.";
        msg.style.display = "block";
      }
    }
    function close(){
      modal.classList.remove("show");
      modal.setAttribute("aria-hidden","true");
      cleanup();
    }
    function cleanup(){
      document.getElementById("pwdSubmit").removeEventListener("click", submit);
      document.getElementById("closePwd").removeEventListener("click", close);
      document.getElementById("pwdBackdrop").removeEventListener("click", close);
    }
    document.getElementById("pwdSubmit").addEventListener("click", submit);
    document.getElementById("closePwd").addEventListener("click", close);
    document.getElementById("pwdBackdrop").addEventListener("click", close);
  });
}

async function openAdmin(){
  const ok = await ensurePassword();
  if(!ok) return;
  const modal = document.getElementById("adminModal");
  modal.classList.add("show");
  modal.setAttribute("aria-hidden","false");
  buildAdminList();
}
function closeAdmin(){
  const modal = document.getElementById("adminModal");
  modal.classList.remove("show");
  modal.setAttribute("aria-hidden","true");
}
function buildAdminList(){
  const box = document.getElementById("adminList");
  if(!box) return;
  const keys = Array.from(new Set(
    Object.keys(PRODUCT_MAP || {}).concat(
      // DATA에 있는 item 키도 포함
      Object.keys(DATA || {}).flatMap(a => Object.keys(DATA[a] || {}).flatMap(t => (DATA[a][t]||[]).map(x=>x.item))).filter(Boolean)
    )
  )).sort((a,b)=>a.localeCompare(b,"ko"));

  box.innerHTML = keys.map(k => {
    const base = (PRODUCT_MAP && PRODUCT_MAP[k]) ? PRODUCT_MAP[k] : k;
    const o = (OVERRIDES && OVERRIDES[k]) ? OVERRIDES[k] : {};
    const name = (o.name !== undefined) ? o.name : base;
    const url = o.url || "";
    const sponsored = !!o.sponsored;
    return `
      <div class="row" data-k="${esc(k)}">
        <div class="k">${esc(k)} <span>(기본: ${esc(base)})</span></div>
        <label>표시 상품명</label>
        <input type="text" data-field="name" value="${esc(name)}" placeholder="예: TIGER 미국S&P500 ETF" />
        <label>링크(선택)</label>
        <input type="text" data-field="url" value="${esc(url)}" placeholder="https:// ..." />
        <div class="tog">
          <input type="checkbox" data-field="sponsored" ${sponsored ? "checked" : ""} />
          <span>광고 배지 표시</span>
        </div>
      </div>
    `;
  }).join("");
}
function collectAdminEdits(){
  const box = document.getElementById("adminList");
  const rows = box ? Array.from(box.querySelectorAll(".row")) : [];
  const next = {};
  rows.forEach(r => {
    const k = r.getAttribute("data-k");
    const name = (r.querySelector('[data-field="name"]')?.value || "").trim();
    const url = (r.querySelector('[data-field="url"]')?.value || "").trim();
    const sponsored = !!(r.querySelector('[data-field="sponsored"]')?.checked);
    if(name || url || sponsored){
      next[k] = { name, url, sponsored };
    }
  });
  return next;
}
function applyOverrides(next){
  OVERRIDES = next || {};
  // 결과 화면이 열려 있다면 즉시 반영
  if(vRes.classList.contains("active") && state.age && state.tier){
    renderResult();
    requestAnimationFrame(() => {
      document.querySelectorAll("[data-bar]").forEach(el => {
        el.style.width = el.getAttribute("data-bar") + "%";
      });
    });
  }
}

document.getElementById("openAdmin")?.addEventListener("click", openAdmin);
document.getElementById("closeAdmin")?.addEventListener("click", closeAdmin);
document.getElementById("adminBackdrop")?.addEventListener("click", closeAdmin);
document.getElementById("saveAdmin")?.addEventListener("click", () => {
  const next = collectAdminEdits();
  saveOverrides(next);
  applyOverrides(next);
  closeAdmin();
});
document.getElementById("resetAdmin")?.addEventListener("click", () => {
  saveOverrides({});
  applyOverrides({});
  buildAdminList();
});
// ESC로 닫기
document.addEventListener("keydown", (e) => {
  if(e.key === "Escape"){
    const modal = document.getElementById("adminModal");
    if(modal && modal.classList.contains("show")) closeAdmin();
  }
});

setProgress(0);
renderAges();
</script>

<!-- Admin Password Modal -->
<div class="modal" id="pwdModal" aria-hidden="true">
  <div class="modal-backdrop" id="pwdBackdrop"></div>
  <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="pwdTitle">
    <div class="modal-head">
      <div>
        <div class="modal-title" id="pwdTitle">관리자 비밀번호</div>
        <div class="modal-sub">8자리 이상 비밀번호를 입력하세요.</div>
      </div>
      <button class="modal-x" id="closePwd" aria-label="닫기">✕</button>
    </div>
    <div class="modal-body">
      <label style="font-size:12px;color:var(--muted)">비밀번호</label>
      <input id="pwdInput" type="password" minlength="8" placeholder="8자리 이상" style="width:100%;margin-top:6px;padding:12px;border-radius:12px;border:1px solid rgba(15,23,42,.12)" />
      <div id="pwdMsg" style="margin-top:10px;font-size:12px;color:#be123c;display:none"></div>
    </div>
    <div class="modal-foot">
      <button class="btn2 primary" id="pwdSubmit">확인</button>
    </div>
  </div>
</div>

</body>
</html>
